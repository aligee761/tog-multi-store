# Custom Nginx for Magento with per-country subdomains and /en|/ar prefixes
# Hosts: uae.localhost, ksa.localhost, oman.localhost, kuwait.localhost

upstream fastcgi_backend {
    server php:9000;
}

# Common PHP location for Magento
map $request_uri $locale_prefix {
    default "";
    ~^/en(/|$) en;
    ~^/ar(/|$) ar;
}

# UAE
server {
    listen 8080;
    server_name uae.localhost;
    root /var/www/html/pub;
    index index.php;

    set $mage_run_code_default "uae_en";
    set $mage_run_code "uae_en";

    if ($locale_prefix = ar) { set $mage_run_code "uae_ar"; }

    location / {
        # Strip /en or /ar from URL for Magento routing
        if ($locale_prefix != "") { rewrite ^/(en|ar)(/.*)? $2 last; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass fastcgi_backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param MAGE_RUN_TYPE store;
        fastcgi_param MAGE_RUN_CODE $mage_run_code;
        fastcgi_read_timeout 600s;
    }

    location ~* \.(ico|css|js|gif|jpe?g|png|svg|woff2?)$ {
        expires max;
        add_header Pragma public;
        add_header Cache-Control "public";
        try_files $uri $uri/ /index.php?$args;
    }
}

# KSA
server {
    listen 8080;
    server_name ksa.localhost;
    root /var/www/html/pub;
    index index.php;

    set $mage_run_code_default "ksa_en";
    set $mage_run_code "ksa_en";

    if ($locale_prefix = ar) { set $mage_run_code "ksa_ar"; }

    location / {
        if ($locale_prefix != "") { rewrite ^/(en|ar)(/.*)? $2 last; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass fastcgi_backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param MAGE_RUN_TYPE store;
        fastcgi_param MAGE_RUN_CODE $mage_run_code;
        fastcgi_read_timeout 600s;
    }

    location ~* \.(ico|css|js|gif|jpe?g|png|svg|woff2?)$ {
        expires max;
        add_header Pragma public;
        add_header Cache-Control "public";
        try_files $uri $uri/ /index.php?$args;
    }
}

# Oman
server {
    listen 8080;
    server_name oman.localhost;
    root /var/www/html/pub;
    index index.php;

    set $mage_run_code_default "oman_en";
    set $mage_run_code "oman_en";

    if ($locale_prefix = ar) { set $mage_run_code "oman_ar"; }

    location / {
        if ($locale_prefix != "") { rewrite ^/(en|ar)(/.*)? $2 last; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass fastcgi_backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param MAGE_RUN_TYPE store;
        fastcgi_param MAGE_RUN_CODE $mage_run_code;
        fastcgi_read_timeout 600s;
    }

    location ~* \.(ico|css|js|gif|jpe?g|png|svg|woff2?)$ {
        expires max;
        add_header Pragma public;
        add_header Cache-Control "public";
        try_files $uri $uri/ /index.php?$args;
    }
}

# Kuwait
server {
    listen 8080;
    server_name kuwait.localhost;
    root /var/www/html/pub;
    index index.php;

    set $mage_run_code_default "kuwait_en";
    set $mage_run_code "kuwait_en";

    if ($locale_prefix = ar) { set $mage_run_code "kuwait_ar"; }

    location / {
        if ($locale_prefix != "") { rewrite ^/(en|ar)(/.*)? $2 last; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass fastcgi_backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param MAGE_RUN_TYPE store;
        fastcgi_param MAGE_RUN_CODE $mage_run_code;
        fastcgi_read_timeout 600s;
    }

    location ~* \.(ico|css|js|gif|jpe?g|png|svg|woff2?)$ {
        expires max;
        add_header Pragma public;
        add_header Cache-Control "public";
        try_files $uri $uri/ /index.php?$args;
    }
}
